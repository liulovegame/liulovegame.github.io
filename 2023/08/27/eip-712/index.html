<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="个人博客"><title>了解 EIP712 | 博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/live2d.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">了解 EIP712</h1><a id="logo" href="/.">博客</a><p class="description">简而不单</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">了解 EIP712</h1><div class="post-meta">Aug 27, 2023<span> | </span><span class="category"><a href="/categories/categories/">categories</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#动机"><span class="toc-number">1.</span> <span class="toc-text">动机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#签名概述"><span class="toc-number">2.</span> <span class="toc-text">签名概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-ECDSA-签名并验证"><span class="toc-number">3.</span> <span class="toc-text">使用 ECDSA 签名并验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是-ECDSA"><span class="toc-number">3.1.</span> <span class="toc-text">什么是 ECDSA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流程"><span class="toc-number">3.2.</span> <span class="toc-text">流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关键词"><span class="toc-number">3.3.</span> <span class="toc-text">关键词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#签名交易流程"><span class="toc-number">3.4.</span> <span class="toc-text">签名交易流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证过程"><span class="toc-number">3.5.</span> <span class="toc-text">验证过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安全问题"><span class="toc-number">3.6.</span> <span class="toc-text">安全问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EIP712"><span class="toc-number">4.</span> <span class="toc-text">EIP712</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EIP712-之前"><span class="toc-number">4.1.</span> <span class="toc-text">EIP712 之前</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EIP712-的改进"><span class="toc-number">4.2.</span> <span class="toc-text">EIP712 的改进</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EIP712-的使用"><span class="toc-number">4.3.</span> <span class="toc-text">EIP712 的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web3-js-调用"><span class="toc-number">4.4.</span> <span class="toc-text">web3.js 调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EIP-数据组装"><span class="toc-number">4.4.1.</span> <span class="toc-text">EIP 数据组装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数据签署"><span class="toc-number">4.4.2.</span> <span class="toc-text">数据签署</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><p>以太坊钱包如 MetaMask 都支持 EIP712 —— 类型结构化消息签名标准，，让钱包可以结构化和可读的格式在签名提示中显示数据。EIP712 在安全性和可用性方面向前迈进了一大步，因为用户不再需要对难以理解的十六进制字符串签名（这是一种令人困惑、不安全的做法）。</p>
<h2 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h2><p>这个 EIP 旨在提高链下消息签名对链上的可用性。我们可以看到，因为节省 gas 以及减少链上交易的原因，采用链下消息签名的需求日益增长。现在已经被签名的消息，展示给用户的是一串难以理解的 16 进制的字符串，附带一些组成这个消息的项目的上下文。</p>
<h2 id="签名概述"><a href="#签名概述" class="headerlink" title="签名概述"></a>签名概述</h2><p>签名的作用或目的？<br>身份认证：证明你拥有地址的私钥；<br>不可否认：确认你的确发布过该消息；<br>完整性：确保信息没有被篡改；</p>
<h2 id="使用-ECDSA-签名并验证"><a href="#使用-ECDSA-签名并验证" class="headerlink" title="使用 ECDSA 签名并验证"></a>使用 ECDSA 签名并验证</h2><h3 id="什么是-ECDSA"><a href="#什么是-ECDSA" class="headerlink" title="什么是 ECDSA"></a>什么是 ECDSA</h3><p>ECDSA 可理解为以太坊、比特币对消息、交易进行签名与验证的算法与流程。在智能合约层面，我们不必多关注其算法的细节，只需理解其流程，看得懂已有项目代码，可以在项目写出对应功能代码即可。</p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>签名即正向算法（消息 + 私钥 + 随机数）= 签名，其中消息是公开的，私钥是隐私的，经过 ECDSA 正向算法可得到签名，即 r、s、v（不用纠结与 r、s、v 到底什么，只需要知道这就是签名即可）。<br>验证即反向算法（消息 + 签名）= 公钥，其中消息是公开的，签名是公开的，经过 ECDSA 反向算法可得到公钥，然后对比已公开的公钥。</p>
<h3 id="关键词"><a href="#关键词" class="headerlink" title="关键词"></a>关键词</h3><p>RLP：一种序列化的方式，其与网络传输中 json 的序列化/反序列化有一些不同，RLP 不仅兼顾网络传输，其编码特性更确保了编码后的一致性，因为每笔交易过程中要进行 Keccak256，如果不能保证编码后的一致性，会导致其 Hash 值不同，那么验证者就无法验证交易是否由同一个人发出。<br>若对上面的阐述不理解，继续看下面的内容。<br>编码方式详情见详解 <a href="https://learnblockchain.cn/books/geth/part3/rlp.html" target="_blank" rel="noopener">以太坊 RLP 编码</a>（不用过度研究）。<br>Keccak256 ：以太坊的 Hash 算法，生成 32 个字节 Hash 值。</p>
<h3 id="签名交易流程"><a href="#签名交易流程" class="headerlink" title="签名交易流程"></a>签名交易流程</h3><ol>
<li><p>构建原始交易对象</p>
<ul>
<li>nonce: 记录发起交易的账户已执行交易总数。Nonce 的值随着每个新交易的执行不断增加，这能让网络了解执行交易需要遵循的顺序，并且作为交易的重放保护。</li>
<li>gasPrice:该交易每单位 gas 的价格，Gas 价格目前以 Gwei 为单位（即 10^9wei），其范围是大于 0.1Gwei，可进行灵活设置。</li>
<li>gasLimit:该交易支付的最高 gas 上限。该上限能确保在出现交易执行问题（比如陷入无限循环）之时，交易账户不会耗尽所有资金。一旦交易执行完毕，剩余所有 gas 会返还至交易账户。</li>
<li>to：该交易被送往的地址（调用的合约地址或转账对方的账户地址）。</li>
<li>value：交易发送的以太币总量。</li>
<li>data:<ul>
<li>若该交易是以太币交易，则 data 为空；</li>
<li>若是部署合约，则 data 为合约的 bytecode；</li>
<li>若是合约调用，则需要从合约 ABI 中获取函数签名，并取函数签名 hash 值前 4 字节与所有参数的编码方式值进行拼接而成，具体参见文章 Ethereum 的合约 ABI 拓展</li>
</ul>
</li>
<li>chainId：防止跨链重放攻击。 -&gt;EIP155</li>
</ul>
</li>
<li><p>签署交易<br>签署交易可使用 MetaMask 和 ethers 库。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ethers = <span class="built_in">require</span>(<span class="string">"ethers"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将RPC与私钥存储在环境变量中</span></span><br><span class="line"><span class="comment">// RPC节点连接，直接用alchemy即可</span></span><br><span class="line"><span class="keyword">let</span> provider = <span class="keyword">new</span> ethers.providers.JsonRpcProvider(process.env.RPC_URL);</span><br><span class="line"><span class="comment">// 新建钱包对象</span></span><br><span class="line"><span class="keyword">let</span> wallet = <span class="keyword">new</span> ethers.Wallet(process.env.PRIVATE_KEY, provider);</span><br><span class="line"><span class="comment">// 返回这个地址已经发送过多少次交易</span></span><br><span class="line"><span class="keyword">const</span> nonce = <span class="keyword">await</span> wallet.getTransactionCount();</span><br><span class="line"><span class="comment">// 构造raw TX</span></span><br><span class="line">tx = &#123;</span><br><span class="line">  nonce: nonce,</span><br><span class="line">  gasPrice: <span class="number">100000000000</span>,</span><br><span class="line">  gasLimit: <span class="number">1000000</span>,</span><br><span class="line">  to: <span class="literal">null</span>,</span><br><span class="line">  value: <span class="number">0</span>,</span><br><span class="line">  data: <span class="string">""</span>,</span><br><span class="line">  chainId: <span class="number">1</span>, <span class="comment">//也可以自动获取chainId = provider.getNetwork()</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 签名，其中过程见下面详述</span></span><br><span class="line"><span class="keyword">let</span> resp = <span class="keyword">await</span> wallet.signTransaction(tx);</span><br><span class="line"><span class="built_in">console</span>.log(resp);</span><br><span class="line"><span class="comment">// 发送交易</span></span><br><span class="line"><span class="keyword">const</span> sentTxResponse = <span class="keyword">await</span> wallet.sendTransaction(tx);</span><br></pre></td></tr></table></figure>
<p>wallet.signTransaction 中发生了什么？<br>对(nonce, gasPrice, gasLimit, to, value, data, chainId, 0, 0)进行 RLP 编码；<br>对上面的 RLP 编码值进行 Keccak256 ；<br>对上面的 Keccak256 值进行 ECDSA 私钥签名（即正向算法）；<br>对上面的 ECDSA 私钥签名(v、r、s)结果与交易消息再次进行 RPL 编码，即 RLP(nonce, gasPrice, gasLimit, to, value, data, v, r, s)，可得到如下编码；</p>
<p>为什么步骤 1 中包含 chainId 字段，而步骤 4 中再次编码时没有 chainId 字段？原始消息内容都不一样，怎么可能会验证通过？先别急，这是因为 chainId 是被编码到签名的 v 参数中的，因此我们不会将 chainId 本身包含在最终的签名交易数据中</p>
</li>
</ol>
<h3 id="验证过程"><a href="#验证过程" class="headerlink" title="验证过程"></a>验证过程</h3><p>交易签名发送后，以太坊节点如何进行身份认证、不可否认、完整性？</p>
<ol>
<li>对上面最终的 RPL 解码，可得到(nonce, gasPrice, gasLimit, to, value, data, v, r, s)；</li>
<li>对(nonce, gasPrice, gasLimit, to, value, data)和(v,r,s)ECDSA 验证（即反向算法），得到签名者的 address，细心的同学可以看到第一个括号少了 chainId，这是因为 chainId 在 ECDSA 私钥签名（即正向算法） 时被编码到了 v，所以由 v 可以直接解码出 chainId(所以在对上面的 RLP 编码值进行 Keccak256；这一步，肯定是把 chainId 复制了一下，给对上面的 Keccak256 值进行 ECDSA 私钥签名（即正向算法）；这一步用)；</li>
<li>对上面得到的签名者的 address 与签名者公钥推导的 address 进行比对，相等即完成身份认证、不可否认性、完整性</li>
</ol>
<p>我们可以去 <a href="https://app.mycrypto.com/broadcast-transaction" target="_blank" rel="noopener">MyCrypto - Ethereum Wallet Manager</a>，将 wallet.signTransaction 生成的编码复制进去，对上述验证步骤有一个直观的感受，比对一下 ECDSA 反向算法得出的”from”是不是自己的地址？</p>
<h3 id="安全问题"><a href="#安全问题" class="headerlink" title="安全问题"></a>安全问题</h3><p>我们注意到原始交易对象里由 Nonce 和 ChainID 两个字段，这是为了防范双花攻击\重放攻击（双花与重放是相对的，本质都是重复使用一个签名，用自己的签名做对自己有利的重复叫双花，用别人的签名做对自己有利的重复叫重放）：</p>
<ul>
<li>Nonce：账户交易计数，以太坊的账户模型中记录着每个账户 Nonce，即此账户发起过多少次交易。</li>
<li>ChainId：分叉链区分，比如我在以太坊链上给 evil 进行一笔转账交易，evil 又可以去以太坊经典链上重放这笔交易，这时如果我在以太坊经典上也有资产，那么会遭受损失。所以 EIP155 提议加入 ChainId，以防止跨链重放。以太坊 ChainId 为 1，以太坊经典 ChainId 为 61。</li>
</ul>
<h2 id="EIP712"><a href="#EIP712" class="headerlink" title="EIP712"></a>EIP712</h2><p>IDEX 需要在中心化服务器上进行订单的撮合，如何保证订单不会被交易所更改呢？核心就在于我们的每笔交易，在发送到中心化服务器前都会用用户自己的私钥进行签名，然后智能合约在进行结算时会对用户签名进行验证。如果中心化服务器对订单数据有任何改动，都无法通过智能合约的校验。</p>
<h3 id="EIP712-之前"><a href="#EIP712-之前" class="headerlink" title="EIP712 之前"></a>EIP712 之前</h3><p>加密货币领域的格言是:不信任;验证。然而，在 EIP712 之前，用户很难验证被要求签名的数据，在以签名信息作为后续交易基础的 DApp 中，很容易给予更多的信任。</p>
<p>由去中心化交易触发的 MetaMask 弹窗，为了安全地将与钱包地址关联起来，要求用户对订单的哈希值进行签名。不幸的是，由于这个哈希值是一个十六进制字符串，没有专业技术知识的用户无法轻松地验证这个哈希值。对于普通用户来说，更容易盲目地相信 DApp 并点击“签名”，而不是通过麻烦的技术验证。这不利于安全。</p>
<p>如果用户无意中登陆了一个恶意的网络钓鱼 DApp，就可能会签下错误的订单信息。例如，可以欺骗用户，让他们为一笔本来成本较低的交易支付不合理的高额以太币。</p>
<h3 id="EIP712-的改进"><a href="#EIP712-的改进" class="headerlink" title="EIP712 的改进"></a>EIP712 的改进</h3><p><img src="https://github.com/ethereum/EIPs/blob/master/assets/eip-712/eth_signTypedData.png?raw=true" alt="发起的交易确认"></p>
<p>在这里，我们不只是看到一串哈希数据了，而是能看到完整的签名数据，进而可以验证所签名的数据是不是正确的数据，有没有被攥改</p>
<h3 id="EIP712-的使用"><a href="#EIP712-的使用" class="headerlink" title="EIP712 的使用"></a>EIP712 的使用</h3><ul>
<li>‘\x19\x01’ ，固定字符串；</li>
<li>DOMAIN_SEPARATOR，由 constructor 中定义；</li>
<li>keccak256(abi.encode(PERMIT_TYPEHASH, owner, spender, value, nonces[owner]++, deadline))，其中 PERMIT_TYPEHASH 是 constant 变量</li>
</ul>
<p>例如 PayUSD 的多签合约</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// EIP712 Precomputed hashes:</span><br><span class="line">// keccak256(&quot;EIP712Domain(string name,string version,uint256 chainId,address verifyingContract,bytes32 salt)&quot;)</span><br><span class="line">bytes32 constant EIP712DOMAINTYPE_HASH = 0xd87cd6ef79d4e2b95e15ce8abf732db51ec771f1ca2edccf22a46c729ac56472;</span><br><span class="line"></span><br><span class="line">// keccak256(&quot;Simple MultiSig&quot;)</span><br><span class="line">bytes32 constant NAME_HASH = 0xb7a0bfa1b79f2443f4d73ebb9259cddbcd510b18be6fc4da7d1aa7b1786e73e6;</span><br><span class="line"></span><br><span class="line">// keccak256(&quot;1&quot;)</span><br><span class="line">bytes32 constant VERSION_HASH = 0xc89efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc6;</span><br><span class="line"></span><br><span class="line">// keccak256(&quot;MultiSigTransaction(address destination,uint256 value,bytes data,uint256 nonce,address executor,uint256 gasLimit)&quot;)</span><br><span class="line">bytes32 constant TXTYPE_HASH = 0x3ee892349ae4bbe61dce18f95115b5dc02daf49204cc602458cd4c1f540d56d7;</span><br><span class="line"></span><br><span class="line">bytes32 constant SALT = 0x251543af6a222378665a76fe38dbceae4871a070b7fdaf5c6c30cf758dc33cc0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">constructor(uint threshold_, address[] memory owners_, uint chainId) public &#123;</span><br><span class="line">  setOwners_(threshold_, owners_);</span><br><span class="line">  DOMAIN_SEPARATOR = keccak256(abi.encode(EIP712DOMAINTYPE_HASH,</span><br><span class="line">                                          NAME_HASH,</span><br><span class="line">                                          VERSION_HASH,</span><br><span class="line">                                          chainId,</span><br><span class="line">                                          this,</span><br><span class="line">                                          SALT));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function execute(uint8[] memory sigV, bytes32[] memory sigR, bytes32[] memory sigS,</span><br><span class="line">  address destination, uint value, bytes memory data, address executor, uint gasLimit</span><br><span class="line">) external &#123;</span><br><span class="line">  // EIP712 scheme: https://github.com/ethereum/EIPs/blob/master/EIPS/eip-712.md</span><br><span class="line">  bytes32 txInputHash = keccak256(abi.encode(TXTYPE_HASH, destination, value, keccak256(data), nonce, executor, gasLimit));</span><br><span class="line">  bytes32 totalHash = keccak256(abi.encodePacked(&quot;\x19\x01&quot;, DOMAIN_SEPARATOR, txInputHash));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整的合约代码地址在：<a href="https://github.com/christianlundkvist/simple-multisig.git" target="_blank" rel="noopener">simple-multisig</a></p>
<h3 id="web3-js-调用"><a href="#web3-js-调用" class="headerlink" title="web3.js 调用"></a>web3.js 调用</h3><h4 id="EIP-数据组装"><a href="#EIP-数据组装" class="headerlink" title="EIP 数据组装"></a>EIP 数据组装</h4><p>以<a href="https://github.com/christianlundkvist/simple-multisig.git" target="_blank" rel="noopener">simple-multisig</a>为例，发起签署验证</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.首先，定义数据类型:</span></span><br><span class="line"><span class="keyword">const</span> domain = [</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"name"</span>, <span class="attr">type</span>: <span class="string">"string"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"version"</span>, <span class="attr">type</span>: <span class="string">"string"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"chainId"</span>, <span class="attr">type</span>: <span class="string">"uint256"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"verifyingContract"</span>, <span class="attr">type</span>: <span class="string">"address"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"salt"</span>, <span class="attr">type</span>: <span class="string">"bytes32"</span> &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> multiSigTx = [</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"destination"</span>, <span class="attr">type</span>: <span class="string">"address"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"value"</span>, <span class="attr">type</span>: <span class="string">"uint256"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"data"</span>, <span class="attr">type</span>: <span class="string">"bytes"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"nonce"</span>, <span class="attr">type</span>: <span class="string">"uint256"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"executor"</span>, <span class="attr">type</span>: <span class="string">"address"</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">"gasLimit"</span>, <span class="attr">type</span>: <span class="string">"uint256"</span> &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.定义域分隔符和需要签名的应用数据</span></span><br><span class="line"><span class="comment">// 合约地址</span></span><br><span class="line"><span class="keyword">const</span> verifyingContract = <span class="string">'0x0000'</span>;</span><br><span class="line"><span class="comment">// 目的地址</span></span><br><span class="line"><span class="keyword">const</span> destination = <span class="string">'0x0000'</span>;</span><br><span class="line"><span class="comment">// 需要往地址转账</span></span><br><span class="line"><span class="keyword">const</span> value = <span class="string">'0x0000'</span>;</span><br><span class="line"><span class="comment">// 验证成功后的执行信息</span></span><br><span class="line"><span class="keyword">const</span> data = <span class="string">'0xf207564e000'</span>;</span><br><span class="line"><span class="comment">// 执行地址</span></span><br><span class="line"><span class="keyword">const</span> executor = <span class="string">'0x0000'</span>;</span><br><span class="line"><span class="keyword">const</span> gasLimit = = <span class="number">3000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> domainData = &#123;</span><br><span class="line">  name: <span class="string">"Simple MultiSig"</span>,</span><br><span class="line">  version: <span class="string">"1"</span>,</span><br><span class="line">  chainId: <span class="built_in">parseInt</span>(web3.version.network, <span class="number">10</span>),</span><br><span class="line">  verifyingContract: verifyingContract,</span><br><span class="line">  salt: <span class="string">"0x251543af6a222378665a76fe38dbceae4871a070b7fdaf5c6c30cf758dc33cc0"</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> message = &#123;</span><br><span class="line">  destination: destination,</span><br><span class="line">  value: value,</span><br><span class="line">  data: data,</span><br><span class="line">  nonce: <span class="number">1</span>,</span><br><span class="line">  executor: executor,</span><br><span class="line">  gasLimit: gasLimit</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 组装需要签名的数据</span></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">  types: &#123;</span><br><span class="line">    EIP712Domain: domain,</span><br><span class="line">    MultiSigTransaction: multiSigTx,</span><br><span class="line">  &#125;,</span><br><span class="line">  domain: domainData,</span><br><span class="line">  primaryType: <span class="string">"MultiSigTransaction"</span>,</span><br><span class="line">  message: message,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>关于 data 的生成，可以使用 web.js 对需要执行的函数和传参进行编码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> threshold = <span class="number">2</span>; <span class="comment">// 替换为您要设置的 threshold 值</span></span><br><span class="line"><span class="keyword">const</span> owners = [</span><br><span class="line">  <span class="string">"0x2ca300446b23dc9a6d14030f29c686d692288461"</span>,</span><br><span class="line">  <span class="string">"0x87D908f9ae2FaBc677ae4947b943F1921D773EE2"</span>,</span><br><span class="line">  <span class="string">"0xA19E3918EFa152CD7939Ebe0a4b673B9C3842fB2"</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> functionSignature = <span class="string">"setOwners(uint8,address[])"</span>; <span class="comment">// 函数签名</span></span><br><span class="line"><span class="keyword">const</span> encodedParams = web3.eth.abi</span><br><span class="line">  .encodeParameters([<span class="string">"uint8"</span>, <span class="string">"address[]"</span>], [threshold, owners])</span><br><span class="line">  .substr(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">let</span> data =</span><br><span class="line">  web3.eth.abi.encodeFunctionSignature(functionSignature) + encodedParams; <span class="comment">// 拼接函数签名的哈希和编码后的参数</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"data__"</span>, data);</span><br></pre></td></tr></table></figure>
<h4 id="数据签署"><a href="#数据签署" class="headerlink" title="数据签署"></a>数据签署</h4><p>可以使用小狐狸钱包发起<code>signTypedData</code>签署</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">web3.currentProvider.sendAsync(</span><br><span class="line">  &#123;</span><br><span class="line">    method: <span class="string">"eth_signTypedData_v3"</span>,</span><br><span class="line">    params: [signer, <span class="built_in">JSON</span>.stringify(data)],</span><br><span class="line">    <span class="keyword">from</span>: signer,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">console</span>.error(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> signature = result.result.substring(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">const</span> r = <span class="string">"0x"</span> + signature.substring(<span class="number">0</span>, <span class="number">64</span>);</span><br><span class="line">    <span class="keyword">const</span> s = <span class="string">"0x"</span> + signature.substring(<span class="number">64</span>, <span class="number">128</span>);</span><br><span class="line">    <span class="keyword">const</span> v = <span class="built_in">parseInt</span>(signature.substring(<span class="number">128</span>, <span class="number">130</span>), <span class="number">16</span>);</span><br><span class="line">    <span class="comment">// The signature is now comprised of r, s, and v.</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>也可以使用以太坊的<code>eth-sig-util</code> 库，需要传入私钥</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ethSigUtil = <span class="built_in">require</span>(<span class="string">"eth-sig-util"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = ethSigUtil.signTypedData(<span class="keyword">new</span> Buffer(privateKey, <span class="string">"hex"</span>), &#123;</span><br><span class="line">  data,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> signature = result.substring(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">const</span> r = <span class="string">"0x"</span> + signature.substring(<span class="number">0</span>, <span class="number">64</span>);</span><br><span class="line"><span class="keyword">const</span> s = <span class="string">"0x"</span> + signature.substring(<span class="number">64</span>, <span class="number">128</span>);</span><br><span class="line"><span class="keyword">const</span> v = <span class="built_in">parseInt</span>(signature.substring(<span class="number">128</span>, <span class="number">130</span>), <span class="number">16</span>);</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/javascript/">javascript</a><a href="/tags/web3/">web3</a></div><div class="post-nav"><a class="next" href="/2023/08/16/truffle-use/">Truffle的简单使用</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/categories/">categories</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/react/">react</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/IM/" style="font-size: 15px;">IM</a> <a href="/tags/WebRTC/" style="font-size: 15px;">WebRTC</a> <a href="/tags/Promise/" style="font-size: 15px;">Promise</a> <a href="/tags/console/" style="font-size: 15px;">console</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a> <a href="/tags/web3/" style="font-size: 15px;">web3</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/mongodb/" style="font-size: 15px;">mongodb</a> <a href="/tags/资料/" style="font-size: 15px;">资料</a> <a href="/tags/cavnas/" style="font-size: 15px;">cavnas</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/题库/" style="font-size: 15px;">题库</a> <a href="/tags/redux/" style="font-size: 15px;">redux</a> <a href="/tags/html/" style="font-size: 15px;">html</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2023/08/27/eip-712/">了解 EIP712</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/08/16/truffle-use/">Truffle的简单使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/30/nextjs-and-cms/">Nextjs + Tailwind css + Strapi CMS 使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/06/24/date-timezone/">将 JavaScript 日期初始化为特定时区</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/30/directory-structure/">项目目录结构推荐</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/09/input-blur/">input 失去焦点重复校验</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/09/tampermonkey/">油猴脚本教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/09/auto-jump-history/">页面加载时使用脚本自动跳转到新页面浏览器不会产生历史记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/08/flex-finally-width/">关于flex布局的最后一行元素宽度问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/07/ unicode/">Unicode编码和解码</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://www.baidu.com/" title="百度" target="_blank">百度</a><ul></ul><a href="https://translate.google.cn/#en/zh-CN" title="谷歌翻译" target="_blank">谷歌翻译</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><div id="landlord"><div class="message"></div><canvas class="live2d" id="live2d" width="280" height="250"></canvas></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script><script type="text/javascript" src="//lib.baomitu.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/contextMenu.js?v=0.0.0"></script><script type="text/javascript" src="/js/live2d.js?v=0.0.0"></script><script type="text/javascript" src="/js/message.js?v=0.0.0"></script></div></body></html>